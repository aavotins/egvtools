% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/input2egv.R
\name{input2egv}
\alias{input2egv}
\title{Convert an input raster to an EGV-aligned raster}
\usage{
input2egv(
  input,
  egv_template,
  summary_function = "average",
  missing_job = c("CoverInput", "CoverOutput", "FillOutput", "CoverInput-CoverOutput",
    "CoverInput-FillOutput", "none"),
  input_bg = NULL,
  input_template = NULL,
  output_bg = NULL,
  idw_weight = 2,
  is_categorical = FALSE,
  check_alignment = TRUE,
  outlocation = "./Rastri_100m/RAW/",
  outfilename,
  layername,
  plot_gaps = FALSE,
  plot_final = FALSE,
  NAflag = NULL,
  gdal_opts = c("COMPRESS=LZW", "TILED=YES", "BIGTIFF=IF_SAFER", "NUM_THREADS=ALL_CPUS",
    "BLOCKXSIZE=256", "BLOCKYSIZE=256"),
  write_datatype = NULL,
  terra_memfrac = 0.7,
  terra_tempdir = tempdir(),
  terra_todisk = TRUE,
  force_gc = FALSE,
  return_visible = FALSE,
  quiet = FALSE
)
}
\arguments{
\item{input}{\code{terra::SpatRaster} or character path (fine resolution input).}

\item{egv_template}{\code{terra::SpatRaster} or path (coarser EGV template).}

\item{summary_function}{Character resample method. Default \code{"average"}; \code{"mean"} is mapped to \code{"average"}.
If \code{is_categorical = TRUE}, \code{"near"} is enforced.}

\item{missing_job}{One of \code{"CoverInput"}, \code{"CoverOutput"}, \code{"FillOutput"},
\code{"CoverInput-CoverOutput"}, \code{"CoverInput-FillOutput"}, \code{"none"}. Default \code{"none"}.}

\item{input_bg}{Background for CoverInput: \code{SpatRaster}, path, or \strong{numeric} (+ \code{input_template}).}

\item{input_template}{Template used when \code{input_bg} is numeric (builds a background raster).}

\item{output_bg}{Background for CoverOutput: \code{SpatRaster}, path, or \strong{numeric} (+ \code{egv_template}).}

\item{idw_weight}{Numeric power for Whitebox IDW. Default \code{2}.}

\item{is_categorical}{Logical; if \code{TRUE}, use \code{"near"} and skip WBT fill. Default \code{FALSE}.}

\item{check_alignment}{Logical; if \code{TRUE}, cheaply checks CRS/res; warns if mismatched. Default \code{TRUE}.}

\item{outlocation}{Output directory. Default \code{"./Rastri_100m/RAW/"}.}

\item{outfilename}{Output filename (e.g., \code{"layer.tif"}). \strong{Required}.}

\item{layername}{Layer name to assign before writing. \strong{Required}.}

\item{plot_gaps}{Logical; plot the \strong{initial} gap map (guarded by \code{interactive()}). Default \code{FALSE}.}

\item{plot_final}{Logical; plot the final raster (guarded by \code{interactive()}). Default \code{FALSE}.}

\item{NAflag}{Optional numeric NA flag for writing. Default \code{NULL} (terra default).}

\item{gdal_opts}{Character vector of GDAL creation options (merged with tuned defaults). Default
\code{c("COMPRESS=LZW","TILED=YES","BIGTIFF=IF_SAFER","NUM_THREADS=ALL_CPUS","BLOCKXSIZE=256","BLOCKYSIZE=256")}.}

\item{write_datatype}{Optional terra datatype (e.g., \code{"FLT4S"}, \code{"INT2S"}). Default \code{NULL}.}

\item{terra_memfrac}{Memory fraction for \code{terraOptions(memfrac=...)}. Default \code{0.7}.}

\item{terra_tempdir}{Temp dir for terra/Whitebox operations. Default: \code{tempdir()}.}

\item{terra_todisk}{Logical (set \code{terraOptions(todisk=...)} for this run). Default \code{TRUE}.}

\item{force_gc}{Logical; if \code{TRUE}, call \code{gc()} at checkpoints. Default \code{FALSE}.}

\item{return_visible}{Logical; if \code{TRUE}, return data.frame is visible; otherwise invisible. Default \code{FALSE}.}

\item{quiet}{Logical; suppress console messages. Default \code{FALSE}.}
}
\value{
A \strong{single-row \code{data.frame}} with:
\itemize{
\item \code{path} (character): written file path
\item \code{method} (character): resample method used
\item \code{missing_job} (character)
\item \code{n_gaps_initial} (integer; after resample/CoverInput, before output-stage ops)
\item \code{n_gaps_final} (integer; after CoverOutput/FillOutput)
\item \code{max_gap_dist} (numeric; \code{NA} if not computed)
\item \code{filter_w} (integer; \code{NA} if not used)
\item \code{elapsed_sec} (numeric)
}
}
\description{
Align a fine-resolution input raster to a (coarser) EGV template, optionally
cover missing values and/or fill gaps (IDW via Whitebox), and write the result to disk.
Designed for large runs: fast gap counting (inside template footprint only), optional filling,
tuned GDAL write options, and controlled \code{terra} memory/temp behavior.
}
\details{
\strong{Workflow (high level)}
\enumerate{
\item Load \code{input} and \code{egv_template}. Optionally warn on CRS/resolution mismatch (\code{check_alignment}).
\item If \code{missing_job} contains \strong{CoverInput}, build \code{input_bg} (numeric + \code{input_template}, or raster/path)
and \code{terra::cover()} the input.
\item \strong{Resample/aggregate} the input to the template with \code{summary_function}
(\code{"mean"} is linked to \code{"average"}). If \code{is_categorical=TRUE} the method is forced to \code{"near"}.
\item Count \strong{initial gaps} = \code{is.na(aligned) & !is.na(template)}.
\item If \code{missing_job} contains \strong{CoverOutput}, apply \code{terra::cover()} using \code{output_bg}.
\item If \code{missing_job} contains \strong{FillOutput} \strong{and} \code{!is_categorical},
estimate a \strong{maximum gap width} (via \code{terra::distance()} on a fillable mask) and set the
Whitebox \strong{filter width} as \code{ceil(max_gap/pixel_size)*2}.
\item Mask to the template footprint, set the final layer name, optionally plot initial gaps and/or result,
and write with LZW/tiling (adds a \code{PREDICTOR} appropriate to datatype if missing).
\item Return a single-row \strong{data.frame} with path, method, gap counts, max gap, filter size, and elapsed time.
}

\strong{Missing value workflows} (\code{missing_job}):
\itemize{
\item \code{"CoverInput"}: cover the \strong{input} before resampling (with \code{input_bg}).
\item \code{"CoverOutput"}: cover the \strong{resampled} raster (with \code{output_bg}).
\item \code{"FillOutput"}: if gaps remain after resampling, compute a max-gap distance
(via \code{terra::distance}) and call \code{whitebox::wbt_fill_missing_data()} with a filter
width approx. twice the maximum gap (in pixels). Only a minimum clamp (\verb{>= 3}) is applied.
\item Combinations: \code{"CoverInput-CoverOutput"}, \code{"CoverInput-FillOutput"}.
\item \code{"none"}: do nothing about gaps.
}

\strong{Resampling}:
\itemize{
\item Default \code{summary_function = "average"} (area-preserving). \code{"mean"} is mapped to \code{"average"}.
\item If \code{is_categorical = TRUE}, method is forced to \code{"near"}.
}

\strong{I/O and stability}:
\itemize{
\item Writes are tiled/ threaded with \code{LZW} compression. Adds \code{PREDICTOR=2} (floats) or
\code{PREDICTOR=3} (ints) if not provided.
\item \code{terraOptions(memfrac, tempdir, todisk)} are set for the call and \strong{restored} on exit.
\item Console messages use \code{cat()} via a \code{say()} helper and the call is \strong{sink-safe}.
}
}
\examples{
\dontrun{
input2egv(
  input            = "./TestejuPakotni_early/Forests_StandAge_bg0.tif",
  egv_template     = "./Templates/TemplateRasters/LV100m_10km.tif",
  summary_function = "average",
  missing_job      = "CoverInput-FillOutput",
  input_bg         = 0,                     # numeric background + input_template
  input_template   = "./Templates/TemplateRasters/LV10m_10km.tif",
  outlocation      = "./Rastri_100m/RAW/",
  outfilename      = "StandAge_100m.tif",
  layername        = "stand_age",
  force_gc         = TRUE,
  quiet            = FALSE
)
}

}
\seealso{
\code{\link[=polygon2input]{polygon2input()}}, \code{\link[=downscale2egv]{downscale2egv()}}, \code{\link[=distance2egv]{distance2egv()}}
}
