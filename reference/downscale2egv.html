<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Downscale &amp; Align a Raster to a Template, with optional gap fill &amp; IDW smoothing — downscale2egv • egvtools</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Downscale &amp; Align a Raster to a Template, with optional gap fill &amp; IDW smoothing — downscale2egv"><meta name="description" content="Aligns a source raster to a template grid (CRS, resolution, extent), masks to the
template footprint, and optionally:
(1) fills NoData gaps using WhiteboxTools' IDW-based fill_missing_data, and
(2) applies IDW smoothing to reduce blockiness from low-resolution inputs.
Mass preservation: IDW smoothing (and most simple smoothers) are not mass-preserving.
If conservation of totals/means matters (globally or by zones), post-smoothing rescaling
is recommended (see Details).
If interpolation_method = &quot;auto&quot;, integer/factor inputs use &quot;near&quot;;
continuous inputs use &quot;bilinear&quot;."><meta property="og:description" content="Aligns a source raster to a template grid (CRS, resolution, extent), masks to the
template footprint, and optionally:
(1) fills NoData gaps using WhiteboxTools' IDW-based fill_missing_data, and
(2) applies IDW smoothing to reduce blockiness from low-resolution inputs.
Mass preservation: IDW smoothing (and most simple smoothers) are not mass-preserving.
If conservation of totals/means matters (globally or by zones), post-smoothing rescaling
is recommended (see Details).
If interpolation_method = &quot;auto&quot;, integer/factor inputs use &quot;near&quot;;
continuous inputs use &quot;bilinear&quot;."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">egvtools</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/aavotins/egvtools" aria-label="GitHub repository"><span class="fa fab fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Downscale &amp; Align a Raster to a Template, with optional gap fill &amp; IDW smoothing</h1>
      <small class="dont-index">Source: <a href="https://github.com/aavotins/egvtools/blob/HEAD/R/downscale2egv.R" class="external-link"><code>R/downscale2egv.R</code></a></small>
      <div class="d-none name"><code>downscale2egv.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Aligns a source raster to a template grid (CRS, resolution, extent), masks to the
template footprint, and optionally:
(1) fills NoData gaps using WhiteboxTools' IDW-based <code>fill_missing_data</code>, and
(2) applies <strong>IDW smoothing</strong> to reduce blockiness from low-resolution inputs.</p>
<p><strong>Mass preservation:</strong> IDW smoothing (and most simple smoothers) are <strong>not mass-preserving</strong>.
If conservation of totals/means matters (globally or by zones), post-smoothing rescaling
is recommended (see <em>Details</em>).</p>
<p>If <code>interpolation_method = "auto"</code>, integer/factor inputs use <code>"near"</code>;
continuous inputs use <code>"bilinear"</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">downscale2egv</span><span class="op">(</span></span>
<span>  <span class="va">template_path</span>,</span>
<span>  <span class="va">grid_path</span>,</span>
<span>  <span class="va">rawfile_path</span>,</span>
<span>  <span class="va">out_path</span>,</span>
<span>  <span class="va">file_name</span>,</span>
<span>  <span class="va">layer_name</span>,</span>
<span>  interpolation_method <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  buffer_m <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  check_na <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  fill_gaps <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  idw_weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  filter_size_cells <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  plot_gaps <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  plot_result <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  smooth_radius_km <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  smooth_agg_factor <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  smooth_power <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  smooth_epsilon <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  smooth_nmax <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  smooth_force <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  gdal_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COMPRESS=LZW"</span>, <span class="st">"TILED=YES"</span>, <span class="st">"BIGTIFF=IF_SAFER"</span><span class="op">)</span>,</span>
<span>  write_datatype <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  NAflag <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  terra_memfrac <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>  terra_tempdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  terra_todisk <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  force_gc <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  return_visible <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-template-path">template_path<a class="anchor" aria-label="anchor" href="#arg-template-path"></a></dt>
<dd><p>Character path to a template GeoTIFF <strong>or</strong> a <code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code>.</p></dd>


<dt id="arg-grid-path">grid_path<a class="anchor" aria-label="anchor" href="#arg-grid-path"></a></dt>
<dd><p>Character path to a GeoParquet grid <strong>or</strong> an <code>sf</code> object (used only for bbox).</p></dd>


<dt id="arg-rawfile-path">rawfile_path<a class="anchor" aria-label="anchor" href="#arg-rawfile-path"></a></dt>
<dd><p>Character path to the input raster <strong>or</strong> a <code>SpatRaster</code>.</p></dd>


<dt id="arg-out-path">out_path<a class="anchor" aria-label="anchor" href="#arg-out-path"></a></dt>
<dd><p>Character. Directory for the output GeoTIFF (created if missing).</p></dd>


<dt id="arg-file-name">file_name<a class="anchor" aria-label="anchor" href="#arg-file-name"></a></dt>
<dd><p>Character. Output file name (e.g., <code>"result.tif"</code>).</p></dd>


<dt id="arg-layer-name">layer_name<a class="anchor" aria-label="anchor" href="#arg-layer-name"></a></dt>
<dd><p>Character. Band name to set on the output.</p></dd>


<dt id="arg-interpolation-method">interpolation_method<a class="anchor" aria-label="anchor" href="#arg-interpolation-method"></a></dt>
<dd><p><code>"auto"</code> (default), or <code>"bilinear"</code>, <code>"near"</code>, <code>"cubicspline"</code>, <code>"cubic"</code>.</p></dd>


<dt id="arg-buffer-m">buffer_m<a class="anchor" aria-label="anchor" href="#arg-buffer-m"></a></dt>
<dd><p>Numeric. Buffer distance (meters) applied to the grid bbox before cropping. Default <code>10000</code>.</p></dd>


<dt id="arg-check-na">check_na<a class="anchor" aria-label="anchor" href="#arg-check-na"></a></dt>
<dd><p>Logical. If <code>TRUE</code>, report NA gap count (inside template). Default <code>FALSE</code>.</p></dd>


<dt id="arg-fill-gaps">fill_gaps<a class="anchor" aria-label="anchor" href="#arg-fill-gaps"></a></dt>
<dd><p>Logical. If <code>TRUE</code>, fill NA gaps via Whitebox. Default <code>TRUE</code>.</p></dd>


<dt id="arg-idw-weight">idw_weight<a class="anchor" aria-label="anchor" href="#arg-idw-weight"></a></dt>
<dd><p>Numeric. IDW power used by Whitebox gap filling. Default <code>2</code>.</p></dd>


<dt id="arg-filter-size-cells">filter_size_cells<a class="anchor" aria-label="anchor" href="#arg-filter-size-cells"></a></dt>
<dd><p>Integer or <code>"auto"</code>. Window size (in <strong>cells</strong>) for gap filling. Default <code>"auto"</code>.</p></dd>


<dt id="arg-plot-gaps-plot-result">plot_gaps, plot_result<a class="anchor" aria-label="anchor" href="#arg-plot-gaps-plot-result"></a></dt>
<dd><p>Logical flags for diagnostics/plots (side-by-side if both).</p></dd>


<dt id="arg-smooth">smooth<a class="anchor" aria-label="anchor" href="#arg-smooth"></a></dt>
<dd><p>Logical. Enable <strong>IDW</strong> smoothing. Default <code>FALSE</code>.</p></dd>


<dt id="arg-smooth-radius-km">smooth_radius_km<a class="anchor" aria-label="anchor" href="#arg-smooth-radius-km"></a></dt>
<dd><p>Numeric. IDW smoothing radius (km). Default <code>10</code>.</p></dd>


<dt id="arg-smooth-agg-factor">smooth_agg_factor<a class="anchor" aria-label="anchor" href="#arg-smooth-agg-factor"></a></dt>
<dd><p>Integer. Aggregate factor before point creation. Default <code>10</code>.</p></dd>


<dt id="arg-smooth-power">smooth_power<a class="anchor" aria-label="anchor" href="#arg-smooth-power"></a></dt>
<dd><p>Numeric. IDW power. Default <code>0.5</code>.</p></dd>


<dt id="arg-smooth-epsilon">smooth_epsilon<a class="anchor" aria-label="anchor" href="#arg-smooth-epsilon"></a></dt>
<dd><p>Numeric. Small smoothing term (if supported by your <code>terra</code>). Default <code>0</code>.</p></dd>


<dt id="arg-smooth-nmax">smooth_nmax<a class="anchor" aria-label="anchor" href="#arg-smooth-nmax"></a></dt>
<dd><p>Integer. Max neighbors (if supported by your <code>terra</code>). Default <code>50</code>.</p></dd>


<dt id="arg-smooth-force">smooth_force<a class="anchor" aria-label="anchor" href="#arg-smooth-force"></a></dt>
<dd><p>Logical. Allow smoothing for integer/factor rasters (not recommended). Default <code>FALSE</code>.</p></dd>


<dt id="arg-gdal-opts">gdal_opts<a class="anchor" aria-label="anchor" href="#arg-gdal-opts"></a></dt>
<dd><p>Character vector. GDAL creation options; merged with tuned defaults:
<code>c("COMPRESS=LZW","TILED=YES","BIGTIFF=IF_SAFER","NUM_THREADS=ALL_CPUS","BLOCKXSIZE=256","BLOCKYSIZE=256")</code>.</p></dd>


<dt id="arg-write-datatype">write_datatype<a class="anchor" aria-label="anchor" href="#arg-write-datatype"></a></dt>
<dd><p>Character or <code>NULL</code>. Optional terra datatype (e.g., <code>"FLT4S"</code>).</p></dd>


<dt id="arg-naflag">NAflag<a class="anchor" aria-label="anchor" href="#arg-naflag"></a></dt>
<dd><p>Numeric/integer NoData value to write; <code>NULL</code> to omit (default).</p></dd>


<dt id="arg-terra-memfrac">terra_memfrac<a class="anchor" aria-label="anchor" href="#arg-terra-memfrac"></a></dt>
<dd><p><code>terraOptions(memfrac=...)</code>. Default <code>0.7</code>.</p></dd>


<dt id="arg-terra-tempdir">terra_tempdir<a class="anchor" aria-label="anchor" href="#arg-terra-tempdir"></a></dt>
<dd><p>Temp dir for terra operations. Default <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code>.</p></dd>


<dt id="arg-terra-todisk">terra_todisk<a class="anchor" aria-label="anchor" href="#arg-terra-todisk"></a></dt>
<dd><p>Logical or <code>NA</code>. If <code>TRUE</code>, prefer on-disk processing for heavy ops. Default <code>TRUE</code>.</p></dd>


<dt id="arg-force-gc">force_gc<a class="anchor" aria-label="anchor" href="#arg-force-gc"></a></dt>
<dd><p>Logical; call <code><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc()</a></code> at checkpoints. Default <code>FALSE</code>.</p></dd>


<dt id="arg-return-visible">return_visible<a class="anchor" aria-label="anchor" href="#arg-return-visible"></a></dt>
<dd><p>Logical. If <code>TRUE</code>, return the summary visibly; otherwise invisibly. Default <code>FALSE</code>.</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p>Suppress progress prints (<code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code>)? Default <code>FALSE</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <strong>data.frame</strong> with columns:
<code>output</code>, <code>gap_count</code>, <code>max_gap_distance</code>, <code>filter_size_cells</code>, <code>smoothed</code>,
<code>smoothing_radius_used</code>, <code>elapsed_sec</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><strong>Workflow</strong></p><ol><li><p><strong>Inputs</strong>: accepts paths or in-memory objects (<code>SpatRaster</code> / <code>sf</code>).</p></li>
<li><p><strong>Fast crop</strong>: transforms the grid bbox to the template CRS, expands by <code>buffer_m</code>,
crops the raw raster early to minimise work.</p></li>
<li><p><strong>Method auto-choice</strong>: <code>"near"</code> for integer/factor rasters, otherwise <code>"bilinear"</code>.</p></li>
<li><p><strong>Align</strong>: <code>terra::project(raw_crop, template, method)</code> then <code>terra::mask(..., template)</code>.</p></li>
<li><p><strong>Gaps</strong>: optional internal NA counts on the template footprint only.</p></li>
<li><p><strong>Gap fill (optional)</strong>: Whitebox <code>wbt_fill_missing_data</code>, with window auto-sized from
the widest gap (or user <code>filter_size_cells</code>).</p></li>
<li><p><strong>Smoothing (optional)</strong>: IDW via <code><a href="https://rspatial.github.io/terra/reference/interpIDW.html" class="external-link">terra::interpIDW()</a></code> on points derived from an
aggregated version of the filled raster; masked back to template.</p></li>
<li><p><strong>Plotting</strong>: <code>plot_gaps</code>, <code>plot_result</code> (side-by-side if both).</p></li>
<li><p><strong>Write</strong>: atomic write (tmp + rename), LZW, tiling, <code>BIGTIFF=IF_SAFER</code>, threaded;
output CRS <strong>forced to template WKT/EPSG</strong> so <code>crs(out) == crs(template)</code> is TRUE.</p></li>
<li><p><strong>Sink safety &amp; memory</strong>: snapshots/restore sinks (prevents stuck console if interrupted);
<code>terraOptions(memfrac/tempdir/todisk)</code> set then restored; optional <code><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc()</a></code>.</p></li>
</ol><p><strong>IDW smoothing</strong>
Aggregate to points to IDW back to template. Controls:</p><ul><li><p><code>smooth_radius_km</code> search radius (km; converted to template units),</p></li>
<li><p><code>smooth_agg_factor</code> aggregation factor before point creation,</p></li>
<li><p><code>smooth_power</code>, <code>smooth_epsilon</code>, <code>smooth_nmax</code>.
Set <code>smooth_force=TRUE</code> to allow smoothing of integer/factor rasters (not recommended).</p></li>
</ul><p><strong>Mass preservation tips</strong>
The smoothed result will generally <em>not</em> preserve totals/means.</p><ul><li><p><strong>Global</strong>: scale smoothed raster to match global sum.</p></li>
<li><p><strong>Zonal</strong>: compute per-zone factors on the original coarse grid and multiply.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>terra::project(), terra::mask(), terra::interpIDW(),
whitebox::wbt_fill_missing_data(), sfarrow::st_read_parquet()</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="va">out_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">downscale2egv</span><span class="op">(</span></span></span>
<span class="r-in"><span>  template_path <span class="op">=</span> <span class="st">"./Templates/TemplateRasters/LV100m_10km.tif"</span>,</span></span>
<span class="r-in"><span>  grid_path     <span class="op">=</span> <span class="st">"./Templates/TemplateGrids/grid_10km.parquet"</span>,</span></span>
<span class="r-in"><span>  rawfile_path  <span class="op">=</span> <span class="st">"./MyCoarse/coarse_indicator.tif"</span>,</span></span>
<span class="r-in"><span>  out_path      <span class="op">=</span> <span class="va">out_dir</span>,</span></span>
<span class="r-in"><span>  file_name     <span class="op">=</span> <span class="st">"indicator_egv.tif"</span>,</span></span>
<span class="r-in"><span>  layer_name    <span class="op">=</span> <span class="st">"indicator"</span>,</span></span>
<span class="r-in"><span>  fill_gaps     <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  smooth        <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  smooth_radius_km <span class="op">=</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  plot_result   <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andris Avotiņš.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

